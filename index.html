<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Joli Chat</title>
    
    <!-- Reggio Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

    <style>
        /* --- Reggio Palette --- */
        :root {
            --bg-paper: #FDFBF7;
            --bg-canvas: #F2F0E9;
            --glass-white: rgba(255, 255, 255, 0.95);
            
            --color-sage: #7C9082;
            --color-clay: #D4A373;
            --color-stone: #4A4A4A;
            --color-pebble: #A8B5BA;
            --color-alert: #E57373;
            
            --shadow-soft: 0 10px 30px rgba(124, 144, 130, 0.15);
            --radius-main: 20px;
            --radius-small: 12px;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Lato', sans-serif;
            background-color: var(--bg-canvas);
            background-image: radial-gradient(var(--color-sage) 0.5px, transparent 0.5px);
            background-size: 20px 20px;
            color: var(--color-stone);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden; /* Prevent body scroll */
        }

        .hidden { display: none !important; }

        /* --- Main Window Container --- */
        .window-container {
            background-color: var(--glass-white);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.6);
            border-radius: var(--radius-main);
            box-shadow: var(--shadow-soft);
            width: 100%;
            max-width: 900px;
            height: 85vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* --- Screens (Login, Waiting, App) --- */
        .screen-panel {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px; 
            background: linear-gradient(135deg, #fff 0%, var(--bg-canvas) 100%);
            overflow-y: auto; 
        }

        h2 {
            font-family: 'Playfair Display', serif;
            font-size: 2.2rem;
            color: var(--color-sage);
            margin-bottom: 5px;
            margin-top: 0;
        }

        .kindness-note {
            background-color: rgba(255,255,255,0.8);
            border: 1px dashed var(--color-clay);
            border-radius: var(--radius-small);
            padding: 15px;
            margin: 15px 0 20px 0;
            max-width: 500px;
            font-style: italic;
            color: #666;
            line-height: 1.5;
            font-size: 0.95rem;
        }

        .kindness-note strong {
            color: var(--color-clay);
            font-family: 'Playfair Display', serif;
        }
        
        .verse-ref {
            display: block;
            margin-top: 8px;
            font-size: 0.85em;
            color: var(--color-sage);
            font-weight: bold;
        }

        /* Inputs */
        input, select {
            background: #fff;
            border: 1px solid var(--color-pebble);
            border-radius: var(--radius-small);
            padding: 10px 15px;
            font-family: 'Lato', sans-serif;
            font-size: 1rem;
            color: var(--color-stone);
            width: 100%;
            max-width: 280px;
            margin-bottom: 12px;
            transition: border-color 0.2s;
        }

        input:focus {
            outline: none;
            border-color: var(--color-sage);
        }

        /* Buttons */
        button {
            background-color: var(--color-sage);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 10px 25px;
            font-family: 'Lato', sans-serif;
            font-weight: bold;
            font-size: 0.95rem;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        button:hover {
            background-color: #6A7F70;
            transform: translateY(-1px);
        }

        .btn-google {
            background-color: #fff;
            color: #444;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .btn-google:hover { background-color: #f9f9f9; }

        .btn-danger {
            background-color: transparent;
            color: var(--color-alert);
            box-shadow: none;
            border: 1px solid var(--color-alert);
            font-size: 0.8rem;
            padding: 6px 12px;
        }
        .btn-danger:hover { background-color: var(--color-alert); color: white; }

        /* --- Admin Toolbar --- */
        #admin-toolbar {
            background-color: #FDF3E3; 
            border-bottom: 1px solid var(--color-clay);
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: var(--color-clay);
            flex-wrap: wrap; /* allow wrap on small screens */
            gap: 10px;
        }

        .admin-group { display: flex; gap: 8px; align-items: center; }
        .admin-divider { width: 1px; height: 20px; background-color: var(--color-clay); opacity: 0.3; margin: 0 5px; }

        .btn-admin {
            background-color: transparent;
            color: var(--color-clay);
            border: 1px solid var(--color-clay);
            padding: 4px 12px;
            font-size: 0.75rem;
            box-shadow: none;
            white-space: nowrap;
        }
        .btn-admin:hover { background-color: var(--color-clay); color: white; }
        .btn-admin.red { border-color: var(--color-alert); color: var(--color-alert); }
        .btn-admin.red:hover { background-color: var(--color-alert); color: white; }
        
        .frozen-status {
            background-color: var(--color-alert);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            display: none;
        }

        /* --- Chat Interface --- */
        #app-screen {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        #top-bar {
            height: 50px;
            min-height: 50px;
            background-color: rgba(255,255,255,0.8);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            font-family: 'Playfair Display', serif;
            z-index: 2000; /* Above sidebar */
        }
        
        /* Mobile Menu Toggle */
        #menu-toggle {
            display: none; /* Hidden on desktop */
            background: none;
            border: none;
            color: var(--color-stone);
            font-size: 1.5rem;
            padding: 0 10px 0 0;
            box-shadow: none;
            cursor: pointer;
        }

        #chat-interface {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
            position: relative; /* For absolute sidebar on mobile */
        }

        /* Sidebar */
        #user-sidebar {
            width: 250px;
            background-color: var(--bg-canvas);
            border-right: 1px solid rgba(0,0,0,0.05);
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .section-header {
            font-size: 0.7rem;
            color: var(--color-pebble);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 15px 0 5px 5px;
            font-weight: bold;
        }

        .user-item {
            padding: 8px 12px;
            border-radius: var(--radius-small);
            cursor: pointer;
            margin-bottom: 5px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between; 
            gap: 8px;
            font-size: 0.95rem;
        }

        .user-item-content { display: flex; align-items: center; gap: 8px; }

        .user-item:hover { background-color: rgba(255,255,255,0.5); }
        .user-item.selected { 
            background-color: var(--color-sage); 
            color: white; 
            font-weight: bold;
        }
        
        /* Pending/Muted User Style */
        .user-item.pending { background-color: rgba(212, 163, 115, 0.1); border: 1px dashed var(--color-clay); }
        .user-item.muted { opacity: 0.7; }
        .user-item.muted .user-item-content { text-decoration: line-through; color: var(--color-stone); }

        .approve-btn {
            background: var(--color-sage);
            color: white;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 0;
            box-shadow: none;
        }
        .approve-btn:hover { transform: scale(1.1); }

        /* Message Area */
        #message-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-paper);
            width: 100%; /* Ensure full width when sidebar hidden */
        }

        #msg-feed {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .msg {
            max-width: 70%;
            padding: 10px 16px;
            border-radius: 16px;
            font-size: 0.95rem;
            line-height: 1.4;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .msg-meta { font-size: 0.7rem; margin-bottom: 4px; opacity: 0.8; font-weight: bold; display: block; }
        .msg.student { background-color: white; color: var(--color-stone); align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg.self { background-color: var(--color-sage); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg.self .msg-meta { color: rgba(255,255,255,0.9); }
        .msg.admin { background-color: #FDF3E3; border: 1px solid var(--color-clay); color: #8D6E63; align-self: center; max-width: 80%; }
        .msg.admin .msg-meta { color: var(--color-clay); font-family: 'Playfair Display', serif; }
        .msg.private { border: 1px dashed var(--color-pebble); }

        .chat-image { max-width: 100%; border-radius: 8px; margin-top: 8px; border: 4px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* Input Area */
        #input-area {
            padding: 12px 15px;
            background-color: white;
            border-top: 1px solid rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            min-height: 60px; /* Ensure clickable area */
        }
        
        /* Frozen / Muted / Absent States */
        #input-area.frozen::after,
        #input-area.muted::after,
        #input-area.absent::after {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95);
            color: var(--color-sage);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: 'Playfair Display', serif;
            z-index: 10;
            text-align: center;
            padding: 0 20px;
        }
        #input-area.frozen::after { content: "The room is currently paused for listening."; }
        #input-area.muted::after { content: "Your voice is currently paused by the Guide."; color: var(--color-stone); }
        #input-area.absent::after { content: "The Guide has stepped away. Room is waiting."; color: var(--color-clay); }

        #msg-input {
            flex-grow: 1;
            margin: 0;
            border: 1px solid #eee;
            background-color: var(--bg-paper);
        }

        .icon-btn {
            background: none;
            border: none;
            color: var(--color-sage);
            padding: 6px;
            box-shadow: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .icon-btn:hover { background-color: var(--bg-canvas); transform: none; }
        .icon-btn svg { width: 22px; height: 22px; stroke-width: 2; }

        /* --- Affirmation Emoji Picker --- */
        #emoji-picker {
            position: absolute;
            bottom: 60px;
            left: 20px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: var(--radius-small);
            box-shadow: var(--shadow-soft);
            padding: 8px;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            z-index: 100;
        }
        .emoji-btn {
            font-size: 1.4rem;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 5px;
            box-shadow: none;
        }
        .emoji-btn:hover { background: var(--bg-canvas); transform: scale(1.2); }

        /* --- MOBILE RESPONSIVENESS --- */
        @media (max-width: 768px) {
            body { padding: 0; height: 100dvh; } /* Full viewport height */
            
            .window-container {
                width: 100%;
                height: 100%;
                max-width: none;
                border-radius: 0;
                border: none;
            }

            #menu-toggle { display: block; } /* Show Hamburger */

            #user-sidebar {
                position: absolute;
                top: 0;
                left: 0;
                bottom: 0;
                z-index: 1000;
                transform: translateX(-100%); /* Hide by default */
                background-color: rgba(242, 240, 233, 0.98); /* Solid-ish background */
                box-shadow: 5px 0 15px rgba(0,0,0,0.1);
                width: 80%; /* Almost full width */
                max-width: 300px;
            }

            #user-sidebar.open {
                transform: translateX(0); /* Slide in */
            }

            /* Adjust Input for thumb typing */
            #input-area { padding: 10px; }
            #msg-input { font-size: 16px; } /* Prevents iOS zoom */
            
            /* Hide connection text on very small screens to save space */
            #top-bar span[style*="font-size: 0.9rem"] {
                display: none;
            }
        }

    </style>
</head>
<body>

    <div class="window-container">
        
        <!-- 1. LOGIN SCREEN -->
        <div id="login-screen" class="screen-panel">
            <h2>Joli Chat</h2>
            <p style="margin-bottom: 15px; color: var(--color-pebble); font-size: 0.9rem;">Digital Atelier Connection</p>

            <div class="kindness-note">
                <p style="margin-top:0;">Welcome, friend.</p>
                <div id="daily-quote" style="margin: 10px 0; font-family: 'Playfair Display', serif; color: var(--color-stone);">
                    <!-- Random Quote Injected Here -->
                </div>
                <p>Remember: <strong>Everything here is observed and recorded.</strong></p>
                <p style="margin-bottom:0;">Please speak with love, listen with kindness, and share with compassion.</p>
            </div>
            
            <div id="login-form">
                <input type="text" id="room-code" placeholder="Frequency (Room Name)">

                <!-- Google Auth Button (Primary) -->
                <button id="google-btn" onclick="handleGoogleFlow()" class="btn-google" style="margin: 0 auto 10px auto;">
                    <svg width="18" height="18" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                    Sign In with Google
                </button>

                <!-- Hidden Manual Override -->
                <div id="manual-login-area" class="hidden" style="margin-top: 15px;">
                    <input type="text" id="username" placeholder="Your Name">
                    
                    <button onclick="login()">Enter Circle</button>
                    
                    <div id="role-container" class="hidden">
                        <select id="role-select">
                            <option value="student">Student</option>
                            <option value="teacher">Teacher (Guide)</option>
                        </select>
                    </div>
                </div>

                <a style="font-size: 0.8rem; color: var(--color-pebble); cursor: pointer; text-decoration: underline; display: block; margin-top: 20px; padding-bottom: 10px;" onclick="toggleManual()">Manual Override</a>
            </div>
        </div>

        <!-- 2. WAITING SCREEN (New) -->
        <div id="waiting-screen" class="screen-panel hidden">
            <h2 style="font-size: 2rem;">Knocking...</h2>
            <p style="font-style: italic; color: var(--color-clay);">We are letting the Guide know you are here.</p>
            <div style="margin-top: 30px;">
                <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="#7C9082" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
            </div>
            <p style="margin-top: 20px; font-size: 0.9rem;">Please wait for approval to enter.</p>
            <button onclick="signOut()" class="btn-danger" style="margin-top: 20px;">Cancel</button>
        </div>

        <!-- 3. MAIN APP SCREEN -->
        <div id="app-screen" class="hidden">
            <!-- ADMIN TOOLBAR -->
            <div id="admin-toolbar" class="hidden">
                <div class="admin-group">
                    <span><strong>Guide Controls:</strong></span>
                    <button class="btn-admin" onclick="toggleFreezeRoom()" id="freeze-btn">‚ùâ Freeze Room</button>
                    <button class="btn-admin" onclick="downloadChat()">‚á© Save</button>
                    <button class="btn-admin red" onclick="dissolveRoom()">‚úï Clear</button>
                </div>
                
                <!-- Targeted User Controls (Visible when user selected) -->
                <div id="admin-user-controls" class="admin-group hidden">
                    <div class="admin-divider"></div>
                    <span id="target-admin-name" style="font-style:italic;">User</span>
                    <button id="btn-mute" class="btn-admin" onclick="toggleMuteUser()">Mute</button>
                    <button class="btn-admin red" onclick="ejectUser()">‚èè Eject</button>
                </div>
            </div>

            <div id="top-bar">
                <div style="display:flex; align-items:center; gap: 10px;">
                    <!-- MOBILE MENU TOGGLE -->
                    <button id="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
                    
                    <span id="display-room" style="font-weight: bold; color: var(--color-stone);">Room</span>
                    <span id="freeze-badge" class="frozen-status">FROZEN</span>
                </div>
                
                <div style="display:flex; align-items: center; gap: 15px;">
                    <span style="font-size: 0.9rem;">Connected as: <span id="display-name" style="color: var(--color-sage);">User</span></span>
                    <button onclick="signOut()" class="btn-danger">Leave</button>
                </div>
            </div>
            
            <div style="background: var(--color-sage); color: white; padding: 5px; text-align: center; font-size: 0.8rem;">
                Speaking to: <span id="target-display" style="font-weight:bold; font-family: 'Playfair Display', serif; letter-spacing: 1px;">THE WHOLE GROUP</span>
            </div>

            <div id="chat-interface">
                <!-- Left Sidebar: Users -->
                <div id="user-sidebar">
                    <div id="all-users-btn" class="user-item selected" onclick="selectUser('ALL')">
                        <div class="user-item-content">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                            Everyone
                        </div>
                    </div>
                    <div style="height: 1px; background: rgba(0,0,0,0.1); margin: 10px 0;"></div>
                    
                    <div id="pending-section" class="hidden">
                        <div class="section-header">Knocking...</div>
                        <div id="pending-user-list"></div>
                        <div style="height: 1px; background: rgba(0,0,0,0.1); margin: 10px 0;"></div>
                    </div>

                    <div id="dynamic-user-list"></div>
                </div>

                <!-- Right Side: Messages -->
                <div id="message-area">
                    <div id="msg-feed"></div>
                    
                    <div id="input-area">
                        <!-- Emoji Picker -->
                        <div id="emoji-picker" class="hidden">
                            <button class="emoji-btn" onclick="addEmoji('üåø')">üåø</button>
                            <button class="emoji-btn" onclick="addEmoji('üåª')">üåª</button>
                            <button class="emoji-btn" onclick="addEmoji('‚òÄÔ∏è')">‚òÄÔ∏è</button>
                            <button class="emoji-btn" onclick="addEmoji('‚ú®')">‚ú®</button>
                            <button class="emoji-btn" onclick="addEmoji('üí°')">üí°</button>
                            <button class="emoji-btn" onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</button>
                            <button class="emoji-btn" onclick="addEmoji('üòä')">üòä</button>
                            <button class="emoji-btn" onclick="addEmoji('üëè')">üëè</button>
                            <button class="emoji-btn" onclick="addEmoji('üôå')">üôå</button>
                            <button class="emoji-btn" onclick="addEmoji('ü§ù')">ü§ù</button>
                        </div>

                        <!-- Hidden File Input -->
                        <input type="file" id="file-input" accept="image/*" class="hidden" onchange="handleFileSelect()">
                        
                        <!-- Affirmation Button -->
                        <button class="icon-btn" onclick="toggleEmoji()" title="Affirmations" style="color: var(--color-clay);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>
                        </button>

                        <!-- Camera Button -->
                        <button class="icon-btn" onclick="document.getElementById('file-input').click()" title="Share Image">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                        </button>

                        <input type="text" id="msg-input" placeholder="Share a thought..." onkeydown="if(event.key==='Enter') sendMessage()">
                        
                        <!-- Send Button -->
                        <button class="icon-btn" onclick="sendMessage()" title="Send" style="background-color: var(--color-sage); color: white; border-radius: 50%; padding: 10px; width: 40px; height: 40px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // =================================================================
        // FIREBASE CONFIGURATION (PRESERVED)
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyA_5r6DAUKkYv5TFP9XM3K3SnRBtmdUS0g",
            authDomain: "classroom-chat-756d5.firebaseapp.com",
            databaseURL: "https://classroom-chat-756d5-default-rtdb.firebaseio.com",
            projectId: "classroom-chat-756d5",
            storageBucket: "classroom-chat-756d5.firebasestorage.app",
            messagingSenderId: "805467042314",
            appId: "1:805467042314:web:c70e68f316c3a76d73a5f3",
            measurementId: "G-04X2N5MR75"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // --- BIBLE QUOTES ---
        const bibleQuotes = [
            { text: "Be kind and compassionate to one another, forgiving each other, just as in Christ God forgave you.", ref: "Ephesians 4:32" },
            { text: "Love is patient, love is kind. It does not envy, it does not boast, it is not proud.", ref: "1 Corinthians 13:4" },
            { text: "Therefore, as God‚Äôs chosen people, holy and dearly loved, clothe yourselves with compassion, kindness, humility, gentleness and patience.", ref: "Colossians 3:12" },
            { text: "Do to others as you would have them do to you.", ref: "Luke 6:31" },
            { text: "Gracious words are a honeycomb, sweet to the soul and healing to the bones.", ref: "Proverbs 16:24" },
            { text: "Let all that you do be done in love.", ref: "1 Corinthians 16:14" },
            { text: "A kind gesture can reach a wound that only compassion can heal.", ref: "Steve Maraboli (Inspired)" } // Added a placeholder for custom ones
        ];

        // --- STATE ---
        let currentUser = { name: "", room: "", role: "student", status: "pending" }; 
        let selectedTarget = "ALL";
        let dbListeners = [];
        let authUserObject = null;
        let isFrozen = false; 
        let usersData = {}; // Store for admin lookups

        // --- ON LOAD ---
        window.onload = function() {
            // 1. Display Quote
            displayRandomQuote();

            // 2. Parse URL
            const urlParams = new URLSearchParams(window.location.search);
            const roomParam = urlParams.get('room');
            if (roomParam) {
                const roomInput = document.getElementById("room-code");
                roomInput.value = roomParam;
                roomInput.disabled = true;
            }

            const isTeacher = urlParams.get('teacher') === 'true';
            if (isTeacher) {
                currentUser.role = 'teacher';
                document.getElementById("login-screen").querySelector('h2').innerText += " (Guide Mode)";
                toggleManual();
            }

            // 3. Auth Listener
            auth.onAuthStateChanged((user) => {
                const btn = document.getElementById("google-btn");
                if (user) {
                    authUserObject = user;
                    btn.innerHTML = `
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#7C9082" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        Continue as ${user.displayName}`;
                    btn.style.color = "var(--color-sage)";
                    btn.style.borderColor = "var(--color-sage)";
                    document.getElementById("username").value = user.displayName;
                } else {
                    authUserObject = null;
                    btn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg> Sign In with Google`;
                    btn.style.color = "#444";
                    btn.style.borderColor = "#ddd";
                }
            });
            
            // Emoji closer
            document.addEventListener('click', function(e) {
                 const picker = document.getElementById("emoji-picker");
                 const btn = document.querySelector('button[title="Affirmations"]');
                 if (!picker.contains(e.target) && !btn.contains(e.target)) {
                     picker.classList.add("hidden");
                 }
                 // Close Sidebar if clicked outside on mobile
                 const sidebar = document.getElementById("user-sidebar");
                 const menuToggle = document.getElementById("menu-toggle");
                 if (window.innerWidth <= 768 && !sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
                     sidebar.classList.remove("open");
                 }
            });
        };

        // --- UI FUNCTIONS ---
        function displayRandomQuote() {
            const randomIndex = Math.floor(Math.random() * bibleQuotes.length);
            const quote = bibleQuotes[randomIndex];
            const container = document.getElementById('daily-quote');
            container.innerHTML = `"${quote.text}" <span class="verse-ref">${quote.ref}</span>`;
        }

        function toggleManual() {
            const area = document.getElementById("manual-login-area");
            area.classList.toggle("hidden");
        }
        
        function toggleEmoji() {
            document.getElementById("emoji-picker").classList.toggle("hidden");
        }
        
        function addEmoji(emoji) {
            const input = document.getElementById("msg-input");
            input.value += emoji;
            document.getElementById("emoji-picker").classList.add("hidden");
            input.focus();
        }

        // --- MOBILE MENU TOGGLE ---
        function toggleSidebar() {
            const sidebar = document.getElementById("user-sidebar");
            sidebar.classList.toggle("open");
        }

        // --- AUTH FLOW ---
        function handleGoogleFlow() {
            const room = document.getElementById("room-code").value.trim();
            if(!room) return alert("Please enter the Room Name first.");

            if (authUserObject) {
                document.getElementById("username").value = authUserObject.displayName;
                login(true); // Pass true for isGoogle
            } else {
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider)
                    .then((result) => {
                        authUserObject = result.user;
                        document.getElementById("username").value = result.user.displayName;
                        login(true);
                    }).catch((error) => {
                        console.error(error);
                        alert("Google Sign-In Failed: " + error.message);
                    });
            }
        }

        // --- LOGIN LOGIC ---
        function login(isGoogle = false) {
            const name = document.getElementById("username").value.trim();
            const room = document.getElementById("room-code").value.trim();
            
            if(!name || !room) return alert("Please enter your name and room.");

            // Determine Status
            let status = 'pending';
            if (isGoogle) status = 'approved';
            if (currentUser.role === 'teacher') status = 'approved';

            currentUser.name = name;
            currentUser.room = room;
            currentUser.status = status;

            // Room Check
            if (currentUser.role === 'student') {
                db.ref(`rooms/${room}`).get().then((snapshot) => {
                    if (snapshot.exists()) {
                        processLoginStep();
                    } else {
                        alert("Note: This room hasn't been opened by a Teacher yet.");
                        return;
                    }
                }).catch((error) => {
                    alert("Connection Error");
                });
            } else {
                processLoginStep();
            }
        }

        function processLoginStep() {
            if (currentUser.status === 'approved') {
                proceedToApp();
            } else {
                waitForApproval();
            }
        }
        
        function waitForApproval() {
            document.getElementById("login-screen").classList.add("hidden");
            document.getElementById("waiting-screen").classList.remove("hidden");
            
            // Listen for my own status change
            const myStatusRef = db.ref(`rooms/${currentUser.room}/users/${currentUser.name}/status`);
            dbListeners.push(myStatusRef);
            
            myStatusRef.on('value', (snapshot) => {
                if (snapshot.val() === 'approved') {
                    // I have been approved!
                    myStatusRef.off(); // Stop listening to status
                    proceedToApp();
                }
            });
            
            // Initial write for pending user
            const userRef = db.ref(`rooms/${currentUser.room}/users/${currentUser.name}`);
            userRef.set({ 
                role: currentUser.role, 
                status: 'pending',
                lastSeen: Date.now() 
            });
            userRef.onDisconnect().remove();
        }

        function proceedToApp() {
            document.getElementById("login-screen").classList.add("hidden");
            document.getElementById("waiting-screen").classList.add("hidden");
            document.getElementById("app-screen").classList.remove("hidden");
            
            document.getElementById("display-room").innerText = currentUser.room;
            document.getElementById("display-name").innerText = currentUser.name;

            // Show Admin Toolbar if teacher
            if (currentUser.role === 'teacher') {
                document.getElementById("admin-toolbar").classList.remove("hidden");
            }

            // START PRESENCE SYSTEM (Fixes ghosting on mobile sleep/wake)
            setupPresenceSystem();

            listenForMessages();
            listenForUsers();
            listenForRoomState(); 
            listenToMyProfile(); // New: Listen for mute/eject
        }

        function setupPresenceSystem() {
            // Monitor connection state
            const connectedRef = db.ref(".info/connected");
            const userRef = db.ref(`rooms/${currentUser.room}/users/${currentUser.name}`);
            
            // Add to listeners for cleanup
            dbListeners.push(connectedRef);

            connectedRef.on("value", (snap) => {
                if (snap.val() === true) {
                    // We are connected (or reconnected)!
                    // 1. Write our name to the list
                    userRef.update({ 
                        role: currentUser.role, 
                        status: currentUser.status, // Restore last known status
                        lastSeen: Date.now() 
                    });
                    
                    // 2. Tell server to delete us if we disconnect again
                    userRef.onDisconnect().remove();
                }
            });
        }

        function signOut() {
            if(currentUser.name && currentUser.room) {
                db.ref(`rooms/${currentUser.room}/users/${currentUser.name}`).remove();
            }
            dbListeners.forEach(ref => ref.off());
            dbListeners = [];
            
            document.getElementById("msg-feed").innerHTML = "";
            document.getElementById("dynamic-user-list").innerHTML = "";
            document.getElementById("pending-user-list").innerHTML = "";
            
            document.getElementById("app-screen").classList.add("hidden");
            document.getElementById("waiting-screen").classList.add("hidden");
            document.getElementById("login-screen").classList.remove("hidden");
            document.getElementById("admin-toolbar").classList.add("hidden");
            document.getElementById("pending-section").classList.add("hidden");
            document.getElementById("admin-user-controls").classList.add("hidden");
            
            selectedTarget = "ALL";
            document.getElementById("target-display").innerText = "THE WHOLE GROUP";
            
            // Reset local state
            isFrozen = false;
            usersData = {};
        }
        
        function approveUser(uName) {
            db.ref(`rooms/${currentUser.room}/users/${uName}/status`).set('approved');
        }

        // --- LISTENERS ---

        // Listen for MUTE and EJECT on myself
        function listenToMyProfile() {
            const myRef = db.ref(`rooms/${currentUser.room}/users/${currentUser.name}`);
            dbListeners.push(myRef);
            
            myRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) return; 

                // Check Ejected Status
                if (data.status === 'ejected') {
                    alert("You have been removed from the circle.");
                    signOut();
                    return;
                }

                // Check Muted Status
                const inputArea = document.getElementById("input-area");
                const msgInput = document.getElementById("msg-input");
                
                if (data.muted === true) {
                    inputArea.classList.add("muted");
                    inputArea.classList.remove("frozen"); // Priority
                    inputArea.classList.remove("absent");
                    msgInput.disabled = true;
                } else {
                    inputArea.classList.remove("muted");
                    // Only re-enable if not frozen by room state or teacher absence
                    checkGlobalLockState(); 
                }
            });
        }

        function listenForRoomState() {
            const stateRef = db.ref(`rooms/${currentUser.room}/state/frozen`);
            dbListeners.push(stateRef);
            stateRef.on('value', (snapshot) => {
                isFrozen = snapshot.val() === true;
                const freezeBadge = document.getElementById("freeze-badge");
                const freezeBtn = document.getElementById("freeze-btn");

                if (isFrozen) {
                    freezeBadge.style.display = "inline-block";
                    if (freezeBtn) freezeBtn.innerText = "üî• Unfreeze";
                } else {
                    freezeBadge.style.display = "none";
                    if (freezeBtn) freezeBtn.innerText = "‚ùâ Freeze Room";
                }
                checkGlobalLockState();
            });
        }

        function listenForUsers() {
            const usersRef = db.ref(`rooms/${currentUser.room}/users`);
            dbListeners.push(usersRef);

            usersRef.on('value', (snapshot) => {
                usersData = snapshot.val() || {}; // Update global data store
                
                const listDiv = document.getElementById("dynamic-user-list");
                const pendingDiv = document.getElementById("pending-user-list");
                const pendingSection = document.getElementById("pending-section");
                
                listDiv.innerHTML = "";
                pendingDiv.innerHTML = "";
                
                let hasPending = false;
                let teacherPresent = false;
                
                // If selected user still exists, update UI button text
                if (selectedTarget !== 'ALL' && usersData[selectedTarget]) {
                    updateAdminButtons(selectedTarget);
                }
                
                snapshot.forEach((child) => {
                    const uName = child.key;
                    const uData = child.val();
                    
                    // Check for teacher
                    if (uData.role === 'teacher') teacherPresent = true;
                    
                    if(uName !== currentUser.name) {
                        
                        // Icon logic
                        let icon = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>`;
                        if(uData.role === 'teacher') {
                            icon = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#D4A373" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>`;
                        }

                        // STATUS LOGIC
                        if (uData.status === 'pending') {
                            // Only teachers see pending users
                            if (currentUser.role === 'teacher') {
                                hasPending = true;
                                const pDiv = document.createElement("div");
                                pDiv.className = "user-item pending";
                                pDiv.innerHTML = `
                                    <div class="user-item-content">
                                        ${icon} <span>${uName}</span>
                                    </div>
                                    <button class="approve-btn" onclick="approveUser('${uName}')" title="Approve">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    </button>
                                `;
                                pendingDiv.appendChild(pDiv);
                            }
                        } else {
                            // Approved User
                            const div = document.createElement("div");
                            let classes = "user-item";
                            if (uData.muted) classes += " muted";
                            div.className = classes;
                            
                            div.innerHTML = `<div class="user-item-content">${icon} <span>${uName}</span></div>`;
                            div.onclick = () => {
                                selectUser(uName); 
                                div.classList.add("selected");
                                // Close menu on selection on mobile
                                if (window.innerWidth <= 768) toggleSidebar();
                            };
                            listDiv.appendChild(div);
                        }
                    }
                });

                // Toggle visibility of pending section
                if (hasPending && currentUser.role === 'teacher') {
                    pendingSection.classList.remove("hidden");
                } else {
                    pendingSection.classList.add("hidden");
                }

                // Handle Teacher Absence (Auto-Freeze)
                handleTeacherPresence(teacherPresent);
            });
        }

        // --- STATE MANAGEMENT HELPER ---
        function handleTeacherPresence(isPresent) {
            const inputArea = document.getElementById("input-area");
            
            if (currentUser.role === 'teacher') return; // Teachers ignore this

            if (!isPresent) {
                // Force Absent State
                inputArea.classList.add("absent");
                document.getElementById("msg-input").disabled = true;
            } else {
                inputArea.classList.remove("absent");
                checkGlobalLockState(); // Re-evaluate other locks
            }
        }

        function checkGlobalLockState() {
            // Priority: Muted > Absent > Frozen > Open
            const inputArea = document.getElementById("input-area");
            const msgInput = document.getElementById("msg-input");
            
            // If already muted or absent, those take precedence, so only check if neither is active
            if (inputArea.classList.contains("muted") || inputArea.classList.contains("absent")) {
                msgInput.disabled = true;
                return;
            }

            // Check Freeze State
            if (currentUser.role === 'student' && isFrozen) {
                inputArea.classList.add("frozen");
                msgInput.disabled = true;
            } else {
                inputArea.classList.remove("frozen");
                msgInput.disabled = false;
            }
        }

        // --- STANDARD APP FUNCTIONS ---
        function selectUser(targetName) {
            selectedTarget = targetName;
            const display = targetName === 'ALL' ? "THE WHOLE GROUP" : targetName.toUpperCase();
            document.getElementById("target-display").innerText = display;
            document.querySelectorAll(".user-item").forEach(el => el.classList.remove("selected"));
            if (targetName === 'ALL') {
                const allBtn = document.getElementById("all-users-btn");
                if(allBtn) allBtn.classList.add("selected");
            }

            // Update Admin Controls UI
            if (currentUser.role === 'teacher') {
                const controls = document.getElementById("admin-user-controls");
                if (targetName !== 'ALL') {
                    controls.classList.remove("hidden");
                    document.getElementById("target-admin-name").innerText = targetName;
                    updateAdminButtons(targetName);
                } else {
                    controls.classList.add("hidden");
                }
            }
        }

        function updateAdminButtons(targetName) {
            const userData = usersData[targetName];
            if (userData) {
                const muteBtn = document.getElementById("btn-mute");
                if (userData.muted) {
                    muteBtn.innerText = "Unmute";
                    muteBtn.style.backgroundColor = "var(--color-sage)";
                    muteBtn.style.color = "white";
                } else {
                    muteBtn.innerText = "Mute";
                    muteBtn.style.backgroundColor = "transparent";
                    muteBtn.style.color = "var(--color-clay)";
                }
            }
        }

        function handleFileSelect() {
            const fileInput = document.getElementById("file-input");
            const file = fileInput.files[0];
            if (file) {
                if (file.size > 1000000) {
                    alert("Please choose a smaller image (under 1MB).");
                    fileInput.value = ""; return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Data = e.target.result;
                    if (confirm(`Share this image?`)) {
                        db.ref(`rooms/${currentUser.room}/messages`).push({
                            sender: currentUser.name,
                            role: currentUser.role,
                            recipient: selectedTarget,
                            text: "", image: base64Data, timestamp: Date.now()
                        });
                    }
                    fileInput.value = ""; 
                };
                reader.readAsDataURL(file);
            }
        }

        function listenForMessages() {
            const msgsRef = db.ref(`rooms/${currentUser.room}/messages`);
            dbListeners.push(msgsRef);
            msgsRef.limitToLast(100).on('child_added', (snapshot) => {
                const msg = snapshot.val();
                let show = false;
                if (currentUser.role === 'teacher') show = true; 
                else if (msg.sender === currentUser.name) show = true; 
                else if (msg.recipient === 'ALL') show = true; 
                else if (msg.recipient === currentUser.name) show = true; 

                if (show) {
                    const feed = document.getElementById("msg-feed");
                    const div = document.createElement("div");
                    const isPrivate = msg.recipient !== 'ALL';
                    const isAdmin = msg.role === 'teacher';
                    const isSelf = msg.sender === currentUser.name;
                    
                    let classes = "msg";
                    if (isAdmin) classes += " admin";
                    else if (isSelf) classes += " self";
                    else classes += " student";
                    if (isPrivate) classes += " private";
                    div.className = classes;
                    
                    let meta = msg.sender;
                    if(isPrivate) meta += ` (Whisper to ${msg.recipient})`;
                    if(isAdmin) meta = `Guide ${msg.sender}`;

                    let contentHtml = "";
                    if (msg.image) contentHtml += `<img src="${msg.image}" class="chat-image">`;
                    if (msg.text) contentHtml += `<div>${msg.text}</div>`;

                    div.innerHTML = `<span class="msg-meta">${meta}</span>${contentHtml}`;
                    feed.appendChild(div);
                    feed.scrollTop = feed.scrollHeight; 
                }
            });
            msgsRef.on('child_removed', (snapshot) => { document.getElementById("msg-feed").innerHTML = ""; });
        }

        function sendMessage() {
            const input = document.getElementById("msg-input");
            const text = input.value.trim();
            if(!text) return;
            db.ref(`rooms/${currentUser.room}/messages`).push({
                sender: currentUser.name,
                role: currentUser.role, 
                recipient: selectedTarget,
                text: text,
                timestamp: Date.now()
            });
            input.value = "";
        }
        
        // --- ADMIN FUNCTIONS ---
        function toggleFreezeRoom() {
            const newState = !isFrozen;
            db.ref(`rooms/${currentUser.room}/state/frozen`).set(newState);
        }
        function dissolveRoom() {
            if (confirm("Are you sure? This will delete ALL history.")) {
                db.ref(`rooms/${currentUser.room}/messages`).remove();
                db.ref(`rooms/${currentUser.room}/messages`).push({
                    sender: "SYSTEM", recipient: "ALL", text: "Room cleared.", timestamp: Date.now(), role: 'admin'
                });
            }
        }
        function downloadChat() {
            db.ref(`rooms/${currentUser.room}/messages`).once('value', (snapshot) => {
                const msgs = snapshot.val();
                if (!msgs) return alert("No history to save.");

                let textContent = `JOLI CHAT HISTORY: ${currentUser.room}\r\nDate: ${new Date().toLocaleString()}\r\n\r\n`;
                
                // Sort by timestamp
                const sortedMsgs = Object.values(msgs).sort((a, b) => a.timestamp - b.timestamp);

                sortedMsgs.forEach(msg => {
                    const time = new Date(msg.timestamp).toLocaleTimeString();
                    let sender = msg.sender;
                    if (msg.role === 'teacher') sender += " (Guide)";
                    if (msg.recipient !== 'ALL') sender += ` (to ${msg.recipient})`;
                    
                    let content = msg.text || "";
                    
                    // Safety check for massive image data stored as text
                    if (content.length > 500 && !content.includes(" ")) {
                        content = "[Large Data - Omitted]";
                    }
                    if (msg.image) content += " [Image Attachment]";

                    textContent += `[${time}] ${sender}: ${content}\r\n`;
                });

                // Add BOM for UTF-8 compatibility
                const blob = new Blob(['\uFEFF' + textContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${currentUser.room}_history.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });
        }

        // --- NEW ADMIN USER CONTROLS ---
        function toggleMuteUser() {
            if (selectedTarget === 'ALL' || !usersData[selectedTarget]) return;
            
            const isMuted = usersData[selectedTarget].muted === true;
            // Toggle
            db.ref(`rooms/${currentUser.room}/users/${selectedTarget}/muted`).set(!isMuted);
        }

        function ejectUser() {
            if (selectedTarget === 'ALL' || !usersData[selectedTarget]) return;
            
            if (confirm(`Are you sure you want to remove ${selectedTarget} from the room?`)) {
                db.ref(`rooms/${currentUser.room}/users/${selectedTarget}/status`).set('ejected');
                // Reset selection
                selectUser('ALL');
            }
        }

    </script>
</body>
</html>
